/*
 * Thicket
 * https://github.com/d-plaindoux/thicket
 *
 * Copyright (c) 2015 Didier Plaindoux
 * Licensed under the LGPL2 license.
 */

module.exports = (function() {
    function load(M) {

        M.define('native', { '[id]':'native' });
        M.define('Pair',   function(left)   { return function(right) { return { '[id]':'Pair',_1:left, _2:right };};});
        M.define('string', function(native) { return { '[id]':'string','[this]':native };});
        M.define('number', function(native) { return { '[id]':'number','[this]':native };});

        // ------------------------------
        // Public delta rule in internal
        // ------------------------------        
        
        M.code("internal.apply", function(n1) {
            var self = M.$$(n1)['[this]'],
                name = M.$$(self)['[this]'];
            if (M.deltarules.hasOwnProperty(name)) {
                return M.deltarules[name];
            } else {
                throw new Error("no system definition for " + name);
            }
        });
        
        // ------------------------------
        // Generic
        // ------------------------------        
           
        M.code("generic.==", function(n1){
            return function(n2){
                return function(vTrue) {
                    return function(vFalse) {                    
                        var v1 = M.$$(n1)['[this]'],
                            v2 = M.$$(n2)['[this]'];                    
                        if (v1 === v2) {
                            return M.$$(vTrue);
                        } else {
                            return M.$$(vFalse);
                        }
                    };
                };
            };
        });
        
        M.code("generic.<<", function(n1){
            return function(n2){
                return function(vTrue) {
                    return function(vFalse) {                    
                        var v1 = M.$$(n1)['[this]'],
                            v2 = M.$$(n2)['[this]'];                    
                        if (v1 < v2) {
                            return M.$$(vTrue);
                        } else {
                            return M.$$(vFalse);
                        }
                    };
                };
            };
        });
        
        // ------------------------------
        // String
        // ------------------------------        
        
        M.code("string.+", function(n1){
            return function(n2){
                var v1 = M.$$(n1)['[this]'],
                    v2 = M.$$(n2)['[this]'];                    
                return M.$$(M.string(v1+""+v2));
            };
        });
            
        M.code("string.toNumber", function(n1){
            return function(vSome) {
                return function(vNone) {                    
                    var v1 = M.$$(n1)['[this]'],
                        vR = Number(v1);
                    if (isNaN(vR)) {
                        return M.$$(vNone);
                    } else {
                        return M.$$(M.apply(vSome,M.number(vR)));
                    }
                };
            };
        });
            
        M.code("string.hash", function(n1){
            var v1 = M.$$(n1)['[this]'],
                hash = 0;
            
            // cf. http://stackoverflow.com/questions/7616461/
            v1.split('').forEach(function(c) {
                hash = (((hash << 5) - hash) + c.charCodeAt(0)) | 0;
            });
            
            return M.$$(M.number(hash));
        });
        
        // ------------------------------
        // Number
        // ------------------------------
        
        M.code("number.+", function(n1){
            return function(n2){
                var v1 = M.$$(n1)['[this]'],
                    v2 = M.$$(n2)['[this]'];                    
                return M.$$(M.number(v1+v2));
            };
        });
            
        M.code("number.*", function(n1){
            return function(n2){
                var v1 = M.$$(n1)['[this]'],
                    v2 = M.$$(n2)['[this]'];                
                return M.$$(M.number(v1*v2));
            };
        });

        M.code("number.-", function(n1){
                return function(n2){
                    var v1 = M.$$(n1)['[this]'],
                        v2 = M.$$(n2)['[this]'];                    
                    return M.$$(M.number(v1-v2));
                };
        });

        M.code("number./", function(n1){
            return function(n2){
                var v1 = M.$$(n1)['[this]'],
                    v2 = M.$$(n2)['[this]'];                    
                return M.$$(M.number(v1/v2));
            };
        });

        M.code("number.%", function(n1){
            return function(n2){
                var v1 = M.$$(n1)['[this]'],
                    v2 = M.$$(n2)['[this]'];                    
                return M.$$(M.number(v1%v2));
            };
        });
        
        M.code("number.toString", function(n1){
            var v1 = M.$$(n1)['[this]'];                
            return M.$$(M.string(v1+"")); // TODO
        });
        
        // ------------------------------
        // Array
        // ------------------------------
        
        M.code("array.new", function(n1) {
            var v1 = M.$$(n1)['[this]'];
            return new Array(v1);
        });
               
        M.code("array.set", function(n1){
            return function(index){
                return function(value) {
                    var v1 = M.$$(M.$$(n1)['[this]']),
                        vi = M.$$(index)['[this]'];
                    if (vi <= -1 || v1.length <= vi) {
                        return v1;
                    } else {
                        var nv1 = v1.slice();
                        nv1[vi] = value;
                        return nv1;
                    }
                };
            };
        });
        
        M.code("array.reset", function(n1){
            return function(index){
                var v1 = M.$$(M.$$(n1)['[this]']),
                    vi = M.$$(index)['[this]'];
                if (vi <= -1 || v1.length <= vi) {
                    return v1;
                } else {
                    var nv1 = v1.slice();
                    delete nv1[vi];
                    return nv1;
                }
            };
        });
        
        M.code("array.get", function(n1){
            return function(index){
                return function(some) {                    
                    return function(none) {                    
                        var v1 = M.$$(M.$$(n1)['[this]']),
                            vi = M.$$(index)['[this]'];
                        if (vi <= -1 || v1.length <= vi) {
                            return M.$$(none);
                        } else if (v1[vi]) {
                             return M.$$(M.apply(some,v1[vi]));
                        } else {
                            return M.$$(none);
                        }
                    };
                };
            };
        });
                        
        M.code("array.size", function(n1){
            var v1 = M.$$(M.$$(n1)['[this]']);
            return M.$$(M.number(v1.length));    
        });
                        
        return M;
    }
    
    return load;
}());
 